<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <title>TeleSec</title>
  <link rel="icon" type="image/png" href="static/TeleSec.jpg" />
  <style>
    html {
      color-scheme: light only;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
    }

    main {
      /*max-width: 45rem;
            margin: 0 auto;*/
      padding: 0 15px;
    }

    .supermesh-indicator {
      border-top-left-radius: 15px;
      background-color: greenyellow;
      border-top: 5px solid green;
      border-left: 5px solid green;
      padding: 15px;
      max-width: 30rem;
      position: fixed;
      right: 0;
      bottom: 0;
      color: black;
      display: none;
    }

    .supermesh-indicator a {
      color: blue;
    }

    details.supermesh-indicator summary {
      font-size: unset;
    }

    .link,
    a {
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }

    .link:hover,
    a:hover {
      text-decoration: underline;
    }

    #articleID {
      font-family: monospace;
    }

    @media (prefers-color-scheme: dark) {

      .link,
      a {
        color: lightblue;
      }
    }

    @media print {

      .supermesh-indicator,
      .no_print {
        display: none;
      }
    }

    main {
      margin-bottom: 25rem;
    }

    button,
    .button {
      display: inline-block;
      padding: 5px 10px;
      background-color: beige;
      border: 2px solid black;
      font-size: 20px;
      margin: 3px;
      text-decoration: none;
      color: black;
    }

    button:hover,
    .button:hover {
      text-decoration: underline;
    }

    /* https://coolors.co/palette/ff0000-ff8700-ffd300-deff0a-a1ff0a-0aff99-0aefff-147df5-580aff-be0aff */
    .rojo {
      background: #ff0000;
      color: white;
    }

    .btn1 {
      background: #ff0000;
      color: white;
    }

    .btn2 {
      background: #ff8700;
      color: white;
    }

    .btn3 {
      background: #ffd300;
      color: black;
    }

    .btn4 {
      background: #deff0a;
      color: black;
    }

    .btn5 {
      background: #a1ff0a;
      color: black;
    }

    .btn6 {
      background: #0aff99;
      color: black;
    }

    .btn7 {
      background: #0aefff;
      color: black;
    }

    .btn8 {
      background: #147df5;
      color: white;
    }

    .nav-disabled {
      background: black !important;
      color: grey !important;
    }

    .nav-disabled:hover {
      text-decoration: unset !important;
    }

    input,
    select,
    textarea {
      font-size: 18px;
      padding: 5px;
      width: calc(100% - 11px);
    }

    select {
      width: 100%;
    }

    details input,
    details select,
    details textarea {
      font-size: 18px;
      padding: 5px;
      width: calc(100% - 15px);
    }

    input[type="color"] {
      width: 50px;
      height: 50px;
    }

    textarea {
      height: 150px;
    }

    details summary {
      font-size: 20px;
    }

    thead tr {
      background-color: black;
      color: white;
    }


    table {
      display: block;
      line-break: loose;
      width: fit-content;
      min-width: 750px;
      border: 1px solid black;
    }

    table tr th {
      line-break: auto;
    }

    table tr td {
      border-bottom: 3px solid black !important;
      padding: 5px;
    }

    .scase {
      text-transform: lowercase;
    }

    .scase:first-letter {
      text-transform: uppercase;
    }

    table tr:hover td {
      text-decoration: underline;
      background: rgba(200, 200, 200, 0.5);
      /* color: black; */
    }

    table tr:hover td.TextBorder {
      background: inherit;
      color: inherit;
      text-decoration: none;
    }

    fieldset {
      max-width: 25rem;
    }

    .TextBorder {
      color: black;
      text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff,
        1px 1px 0 #fff;
      -webkit-text-stroke: 0.25px #fff;
    }

    code {
      font-size: x-small;
      color: gray;
    }

    .activeSCButton {
      border: 7px dashed beige;
      color: beige;
      background: black !important;
    }

    .btn1.activeSCButton {
      border-color: #ff0000;
      color: #ff0000;
    }

    .btn2.activeSCButton {
      border-color: #ff8700;
      color: #ff8700;
    }

    .btn3.activeSCButton {
      border-color: #ffd300;
      color: #ffd300;
    }

    .btn4.activeSCButton {
      border-color: #deff0a;
      color: #deff0a;
    }

    .btn5.activeSCButton {
      border-color: #a1ff0a;
      color: #a1ff0a;
    }

    .btn6.activeSCButton {
      border-color: #0aff99;
      color: #0aff99;
    }

    .btn7.activeSCButton {
      border-color: #0aefff;
      color: #0aefff;
    }

    .btn8.activeSCButton {
      border-color: #147df5;
      color: #147df5;
    }

    hr {
      border-color: black;
      border-style: solid;
    }

    #snackbar {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 2px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
    }

    #snackbar a {
      color: lightblue;
    }

    #snackbar.show {
      visibility: visible;
    }
  </style>
  <link href="static/toastr.min.css" rel="stylesheet" />
  <!--<link rel="stylesheet" href="static/simplemde.min.css">-->
</head>

<body>
  <details class="supermesh-indicator">
    <summary>
      <b>SuperMesh</b><br />
      <br /><small id="peerPID" style="font-family: monospace">PID ??????????</small>
    </summary>
    <ul id="peerList"></ul>
    <i>Todos los datos están encriptados.</i>
  </details>
  <main>
    <header class="no_print" id="header_hide_query">
      <details id="LinkAccount_details" open>
        <summary>
          <b>TeleSec - <span id="groupId">???</span> - (<span id="peerCount">?</span>
            nodos)</b>
        </summary>
        <fieldset id="auth_fieldSet">
          <legend>Credenciales</legend>
          <br />
          <label>Codigo de grupo:<br />
            <input type="text" id="LinkAccount_group" /></label>
          <br />
          <br />
          <label>Clave secreta:<br />
            <input type="text" id="LinkAccount_secret" /></label>
          <br /><br />
          <button type="button"
            onclick='LinkAccount(document.getElementById("LinkAccount_group").value, document.getElementById("LinkAccount_secret").value, true)'>
            Iniciar sesión
          </button>
        </fieldset>
      </details>
      <!-- <button onclick="displayPost('index')">Ir a la pagina de inicio</button> -->
      <div id="appendApps">
        <!--<a class="button nav-supercafe nav-disabled" disabled>SuperCafé</a>
                <a class="button nav-comedor nav-disabled" disabled>Menú Comedor</a>
                <a class="button nav-recetas nav-disabled" disabled>Recetas</a>-->
      </div>
      <hr />
    </header>
    <div id="container"></div>
    <!-- <br><br><br>
    <footer>
      <hr>
      <details>
        <summary><b>Apps SuperMesh</b></summary>
        <button type="button">
          <img src="static/TeleSec.jpg" alt="" width="100px">
          <br>TeleSec
        </button>
      </details>
    </footer> -->
    <img id="connectStatus" style="bottom: 15px; right: 15px; position: fixed; width: 50px;">
  </main>
  <img id="actionStatus" src="static/ico/statusok.png" style="z-index: 2048;margin: 0px;position: fixed;top: 50%;left: 50%;transform: translate(-50%, -50%);width: 100px;height: 100px;display: none;">
  <script src="static/showdown.min.js"></script>
  <script src="static/jquery.js"></script>
  <script src="static/gun.js"></script>
  <script src="static/webrtc.js"></script>
  <script src="static/sea.js"></script>
  <script src="static/yson.js"></script>
  <script src="static/radix.js"></script>
  <script src="static/radisk.js"></script>
  <script src="static/store.js"></script>
  <script src="static/rindexed.js"></script>
  <script src="static/path.js"></script>
  <script src="static/open.js"></script>
  <script src="static/load.js"></script>
  <!--<script src="static/synchronous.js"></script>-->
  <!--<script src="static/axe.js"></script>-->
  <script src="static/toastr.min.js"></script>
  <script src="static/doublescroll.js"></script>
  <!--<script src="static/simplemde.min.js"></script>-->
  <script async>
    async function getQuota(cb = () => { }) {
      if (navigator.storage && navigator.storage.estimate) {
        const quota = await navigator.storage.estimate();
        // quota.usage -> Number of bytes used.
        // quota.quota -> Maximum number of bytes available.
        const percentageUsed = (quota.usage / quota.quota) * 100;
        console.log(`You've used ${percentageUsed}% of the available storage.`);
        const remaining = quota.quota - quota.usage;
        cb(percentageUsed, remaining)
        console.log(`You can write up to ${remaining} more bytes.`);
      }
    }
    getQuota()
  </script>
  <div id="snackbar">Una nueva versión de TeleSec está disponible, <a id="reload">Pulsa aqui para actualizar.</a></div>
  <script id="pwa">
    let newWorker;

    function showUpdateBar() {
      let snackbar = document.getElementById('snackbar');
      snackbar.className = 'show';
    }

    // The click event on the pop up notification
    document.getElementById('reload').addEventListener('click', function () {
      setTimeout(() => { removeCache() }, 1000)
      newWorker.postMessage({ action: 'skipWaiting' });

    });

    if ('serviceWorker' in navigator) {

      navigator.serviceWorker.register('/sw.js').then(reg => {
        reg.addEventListener('updatefound', () => {
          // A wild service worker has appeared in reg.installing!
          newWorker = reg.installing;

          newWorker.addEventListener('statechange', () => {
            // Has network.state changed?
            switch (newWorker.state) {
              case 'installed':
                if (navigator.serviceWorker.controller) {
                  // new update available
                  showUpdateBar();
                }
                // No update available
                break;
            }
          });
        });
      });

      let refreshing;
      navigator.serviceWorker.addEventListener('controllerchange', function () {
        if (refreshing) return;
        window.location.reload();
        refreshing = true;
      });
    }
  </script>
  <script>
    var EVENTLISTENER = null;
    var EVENTLISTENER2 = null;
    var urlParams = new URLSearchParams(location.search);
    if (urlParams.get("hidenav") == "yes") {
      document.getElementById("header_hide_query").style.display = "none";
    }
    var GROUPID = "";
    // const PUBLIC_KEY = "~cppGiuA4UFUPGTDoC-4r2izVC3F7MfpaCmF3iZdESN4.vntmjgbAVUpF_zfinYY6EKVFuuTYxh5xOrL4KmtdTmc"
    var TABLE = GROUPID + ":telesec.tech.eus";
    const RELAYS = [
      "https://gun-es01.tech.eus/gun",
      "https://gun-es02.tech.eus/gun",
      "https://gun-es03.tech.eus/gun",
      "https://gun-es04.tech.eus/gun",
      "https://gun-es05.tech.eus/gun",
      "https://gun-es06.tech.eus/gun",
      // "https://gun-es07.tech.eus/gun", // No he podido instalar el nodo.
      //"https://gun-manhattan.herokuapp.com/gun",
      //"https://peer.wallie.io/gun",
      //"https://gun.defucc.me/gun",
    ];
    var SECRET = "";
  </script>
  <script id="gun_init">
    window.rtcRoom = "telesec.tech.eus";
    var gun = Gun(RELAYS, {
      axe: false,
      localStorage: true,
      radisk: true,
    });
    var SEA = Gun.SEA;
    var user = gun.user();
    function removeCache() {
      caches.keys().then(function (names) {
        for (let name of names) caches.delete(name);
        console.log("Removing cache " + name);
        console.log("OK");
        location.reload(true);
      });
    }
    function getPeers() {
      var peerCount = 0;
      var peerCountEl = document.getElementById("peerCount");
      var peerListEl = document.getElementById("peerList");
      var list = document.createElement("ul");
      document.getElementById("peerPID").innerText =
        "PID " + gun.back("opt.pid");
      Object.values(gun.back("opt.peers")).forEach((peer) => {
        if (
          peer.wire != undefined &&
          (peer.wire.readyState == 1 || peer.wire.readyState == "open")
        ) {
          peerCount += 1;
          var wireType = peer.wire.constructor.name;
          var wireHType = peer.wire.constructor.name;
          var wireID = peer.id;
          switch (wireType) {
            case "WebSocket":
              wireHType = "Web";
              wireID = wireID.split("/")[2];
              break;
            case "RTCDataChannel":
              wireHType = "Mesh";
              wireID = peer.id;
          }
          var el = document.createElement("li");
          el.innerText = `Nodo ${wireHType}: ${wireID}`;
          list.append(el);
        }
      });
      peerListEl.innerHTML = list.innerHTML;
      peerCountEl.innerText = peerCount;
      if (peerCount < 2){
        document.getElementById("connectStatus").src = "static/ico/connect_ko.svg"
        gun.opt({peers: RELAYS});
      } else {
        document.getElementById("connectStatus").src = "static/ico/connect_ok.svg"
        
      }
    }
    getPeers();
    setInterval(() => {
      getPeers();
    }, 5000);
    function safeuuid(prefix = "AXLUID_") {
      return prefix + crypto.randomUUID().split("-")[4];
    }
  </script>
  <script id="app_logic">
    function tableScroll(query) {
      $(query).doubleScroll();
    }
    //var secretTokenEl = document.getElementById("secretToken");
    var groupIdEl = document.getElementById("groupId");
    var container = document.getElementById("container");
    function LinkAccount(
      LinkAccount_group,
      LinkAccount_secret,
      refresh = false
    ) {
      GROUPID = LinkAccount_group.toUpperCase();
      SECRET = LinkAccount_secret.toUpperCase();

      localStorage.setItem("TELESEC_AUTO", "YES");
      localStorage.setItem("TELESEC_groupid", GROUPID);
      localStorage.setItem("TELESEC_secret", SECRET);

      TABLE = GROUPID + ":telesec.tech.eus";
      //secretTokenEl.innerText = SECRET;
      groupIdEl.innerText = GROUPID;
      document.getElementById("LinkAccount_details").open = false;
      if (refresh == true) {
        location.reload();
      }
    }
    if (localStorage.getItem("TELESEC_AUTO") == "YES") {
      LinkAccount(
        localStorage.getItem("TELESEC_groupid"),
        localStorage.getItem("TELESEC_secret")
      );
    }
    if (urlParams.get("login") != null) {
      LinkAccount(
        urlParams.get("login").split(":")[0],
        urlParams.get("login").split(":")[1]
      );
      //location.search = "";
    }
    function open_page(params) {
      if (params == "") {
        params = "index";
      }
      var path = params.split(",");
      var app = path[0];
      if (path[1] == undefined) {
        PAGES[app].index();
        return;
      }
      PAGES[app].edit(path[1]);
    }
    function setUrlHash(hash) {
      location.hash = "#" + hash;
    }
    window.onhashchange = () => {
      try {
        if (EVENTLISTENER != null) {
          try {
            EVENTLISTENER.off();
            EVENTLISTENER = null;
            EVENTLISTENER2.off();
            EVENTLISTENER2 = null;
            // TypeError: Cannot read properties of null (reading 'off')
          } catch (error) {
            if (!error.name == "TypeError") {
              console.debug("EVENTLISTENER error", error);
            }
          }
        }
      } catch (e) {
        console.debug("EVENTLISTENER onhashchange", e);
      }

      open_page(location.hash.replace("#", ""));
    };
    function download(filename, text) {
      var element = document.createElement("a");
      element.setAttribute(
        "href",
        "data:application/octet-stream;charset=utf-8," +
        encodeURIComponent(text)
      );
      element.setAttribute("download", filename);

      element.style.display = "none";
      document.body.appendChild(element);

      element.click();

      document.body.removeChild(element);
    }
    function resizeInputImage(
      file,
      callback,
      targetHeight = 256,
      targetQuality = 0.75
    ) {
      const reader = new FileReader();

      reader.onload = function (event) {
        const img = new Image();
        img.onload = function () {
          const aspectRatio = img.width / img.height;
          const targetWidth = targetHeight * aspectRatio;

          const canvas = document.createElement("canvas");
          canvas.width = targetWidth;
          canvas.height = targetHeight;

          const ctx = canvas.getContext("2d");

          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

          // Get resized image as Blob
          const dataURL = canvas.toDataURL("image/jpeg", targetQuality);
          callback(dataURL);
        };
        img.src = event.target.result;
      };

      reader.readAsDataURL(file);
    }
    function CurrentISODate() {
      return new Date().toISOString().split("T")[0].replace("T", " ");
    }
    function CurrentISOTime() {
      return new Date().toISOString();
    }

    function betterGunPut(ref, data) {
      ref.put(data, (ack) => {
        if (ack.err) {
          toastr.error("Error al guardar: " + ack.err);
        } else {
          console.debug("Guardado correctamente");
        }
      });
      setTimeout(() => {
        ref.put(data);
      }, 250);
      setTimeout(() => {
        ref.put(data);
      }, 500);
    }
    setInterval(() => {
      betterGunPut(
        gun.get(TABLE).get("heartbeat"),
        "heartbeat-" + CurrentISOTime()
      );
      // console.log("Beep")
      gun.get(TABLE).get("heartbeat").load(console.debug);
    }, 5000);
  </script>
  <script id="app_modules">
    function addCategory(
      parent,
      name,
      icon,
      options,
      values,
      change_cb = () => { }
    ) {
      var details_0 = document.createElement("details"); // children: img_0, summary_0
      //details_0.open = true;
      var img_0 = document.createElement("img");
      img_0.src =
        "static/ico/checkbox_unchecked.png";
      img_0.style.height = "30px";
      if (values[name] != undefined) {
        //details_0.open = true;
        img_0.src =
          "static/ico/checkbox.png";
      }
      var summary_0 = document.createElement("summary");
      var span_0 = document.createElement("span");
      span_0.style.float = "right";
      span_0.append(values[name] || "", " ", img_0);
      summary_0.append(name, span_0);
      details_0.append(summary_0, document.createElement("br"));
      details_0.style.textAlign = "center";
      details_0.style.margin = "5px";
      details_0.style.padding = "5px";
      details_0.style.border = "2px solid black";
      details_0.style.borderRadius = "5px";
      details_0.style.backgroundColor = "white";
      details_0.style.cursor = "pointer";
      details_0.style.width = "calc(100% - 25px)";
      details_0.style.display = "inline-block";
      summary_0.style.padding = "10px";
      // background image at the start of summary_0:
      summary_0.style.backgroundImage = "url('" + icon + "')";
      summary_0.style.backgroundSize = "contain";
      summary_0.style.backgroundPosition = "left";
      summary_0.style.backgroundRepeat = "no-repeat";
      summary_0.style.textAlign = "left";
      summary_0.style.paddingLeft = "55px";
      parent.append(details_0);

      options.forEach((option) => {
        var btn = document.createElement("button");
        var br1 = document.createElement("br");
        //btn.innerText = option.key + ": " + option.value
        btn.append(option.value);
        // for each image in option.img:

        if (option.img) {
          var br2 = document.createElement("br");
          btn.append(br2);
          option.img.forEach((imgsrc) => {
            var img = document.createElement("img");
            img.src = imgsrc;
            img.style.height = "50px";
            img.style.padding = "5px";
            img.style.backgroundColor = "white";
            btn.append(img, " ");
          });
        }
        btn.className = option.className;
        if (values[option.key] == option.value) {
          btn.classList.add("activeSCButton");
        }
        btn.onclick = () => {
          var items = details_0.getElementsByClassName("activeSCButton");
          for (var i = 0; i < items.length; i++) {
            items[i].classList.remove("activeSCButton");
          }
          btn.classList.add("activeSCButton");
          values[option.key] = option.value;
          span_0.innerText = option.value;
          change_cb(values);
          img_0.src =
            "static/ico/checkbox.png";
        };
        btn.style.borderRadius = "20px";
        //btn.style.fontSize="17.5px"
        details_0.append(btn);
      });
    }
    function addCategory_Personas(
      parent,
      options,
      defaultval,
      change_cb = () => { }
    ) {
      var details_0 = document.createElement("details"); // children: img_0, summary_0
      //details_0.open = true;
      var img_0 = document.createElement("img");
      img_0.src =
        "static/ico/checkbox_unchecked.png";
      img_0.style.height = "30px";
      if (defaultval != "") {
        details_0.open = false;
        img_0.src =
          "static/ico/checkbox.png";
      }
      var summary_0 = document.createElement("summary");
      var span_0 = document.createElement("span");
      span_0.style.float = "right";
      var p = SC_Personas[defaultval] || {};
      span_0.append(p.Nombre || "", " ", img_0);
      summary_0.append("Persona", span_0);
      details_0.append(summary_0, document.createElement("br"));
      details_0.style.textAlign = "center";
      details_0.style.margin = "5px";
      details_0.style.padding = "5px";
      details_0.style.border = "2px solid black";
      details_0.style.borderRadius = "5px";
      details_0.style.backgroundColor = "white";
      details_0.style.cursor = "pointer";
      details_0.style.width = "calc(100% - 25px)";
      details_0.style.display = "inline-block";
      summary_0.style.padding = "10px";
      // background image at the start of summary_0:
      summary_0.style.backgroundImage =
        "url('static/ico/user.png')";
      summary_0.style.backgroundSize = "contain";
      summary_0.style.backgroundPosition = "left";
      summary_0.style.backgroundRepeat = "no-repeat";
      summary_0.style.textAlign = "left";
      summary_0.style.paddingLeft = "55px";
      parent.append(details_0);
      var lastreg = "";
      Object.entries(options)
        .sort(PERSONAS_Sorter)
        .map((entry) => {
          var key = entry[0];
          var value = entry[1];
          if (lastreg != value.Region.toUpperCase()) {
            lastreg = value.Region.toUpperCase();
            var h3_0 = document.createElement("h2");
            h3_0.style.margin = "0";
            h3_0.style.marginTop = "15px";
            h3_0.innerText = lastreg;
            details_0.append(h3_0);
          }
          var option = value.Nombre;
          var btn = document.createElement("button");
          var br1 = document.createElement("br");
          //btn.innerText = option.key + ": " + option.value
          btn.append(option);

          var br2 = document.createElement("br");
          btn.append(br2);
          var img = document.createElement("img");
          img.src = value.Foto;
          img.style.height = "60px";
          img.style.padding = "5px";
          img.style.backgroundColor = "white";
          btn.append(img, " ");

          if (defaultval == key) {
            btn.classList.add("activeSCButton");
          }
          btn.onclick = () => {
            var items = details_0.getElementsByClassName("activeSCButton");
            for (var i = 0; i < items.length; i++) {
              items[i].classList.remove("activeSCButton");
            }
            btn.classList.add("activeSCButton");
            defaultval = key;
            span_0.innerText = "";
            var img_5 = document.createElement("img")
            img_5.src = value.Foto
            img_5.style.height = "30px"
            span_0.append(img_5, value.Nombre);
            change_cb(defaultval);
            img_0.src =
              "static/ico/checkbox.png";
          };
          btn.style.borderRadius = "20px";
          //btn.style.fontSize="17.5px"
          details_0.append(btn);
        });
    }
    const SC_actions_icons = {
      Tamaño:
        "static/ico/sizes.png",
      Temperatura:
        "static/ico/thermometer2.png",
      Leche:
        "static/ico/milk.png",
      Selección:
        "static/ico/preferences.png",
      Cafeina:
        "static/ico/coffee_bean.png",
      Endulzante:
        "static/ico/lollipop.png",
      Receta:
        "static/ico/cookies.png",
    };
    const SC_actions = {
      Tamaño: [
        {
          value: "Grande",
          key: "Tamaño",
          className: "btn1",
          img: [
            "static/ico/keyboard_key_g.png",
          ],
        },
        {
          value: "Pequeño",
          key: "Tamaño",
          className: "btn1",
          img: [
            "static/ico/keyboard_key_p.png",
          ],
        },
      ],
      Temperatura: [
        {
          value: "Caliente",
          key: "Temperatura",
          className: "btn2",
          img: [
            "static/ico/thermometer2.png",
            "static/ico/arrow_up_red.png",
            "static/ico/fire.png",
          ],
        },
        {
          value: "Templado",
          key: "Temperatura",
          className: "btn2",
          img: [
            "static/ico/thermometer2.png",
            "static/ico/arrow_left_green.png",
          ],
        },
        {
          value: "Frio",
          key: "Temperatura",
          className: "btn2",
          img: [
            "static/ico/thermometer2.png",
            "static/ico/arrow_down_blue.png",
            "static/ico/snowflake.png",
          ],
        },
      ],
      Leche: [
        {
          value: "de Vaca",
          key: "Leche",
          className: "btn3",
          img: [
            "static/ico/cow.png",
            "static/ico/add.png",
          ],
        },
        {
          value: "Sin lactosa",
          key: "Leche",
          className: "btn3",
          img: [
            "static/ico/cow.png",
            "static/ico/delete.png",
          ],
        },
        {
          value: "Vegetal",
          key: "Leche",
          className: "btn3",
          img: [
            "static/ico/milk.png",
            "static/ico/wheat.png",
          ],
        },
        {
          value: "Agua",
          key: "Leche",
          className: "btn3",
          img: [
            "static/ico/water_tap.png",
          ],
        },
      ],
      Selección: [
        {
          value: "Solo Leche",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/milk.png",
          ],
        },
        {
          value: "Solo café (sin leche)",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/coffee_bean.png",
          ],
        },
        {
          value: "Café con leche",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/coffee_bean.png",
            "static/ico/milk.png",
          ],
        },
        {
          value: "ColaCao con leche",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/colacao.jpg",
            "static/ico/milk.png",
          ],
        },
        {
          value: "Leche con cereales",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/cereales.png",
            "static/ico/milk.png",
          ],
        },
        {
          value: "Infusión",
          key: "Selección",
          className: "btn4",
          img: [
            "static/ico/tea_bag.png",
          ],
        },
      ],
      Cafeina: [
        {
          value: "Con",
          key: "Cafeina",
          className: "btn5",
          img: [
            "static/ico/coffee_bean.png",
            "static/ico/add.png",
          ],
        },
        {
          value: "Sin",
          key: "Cafeina",
          className: "btn5",
          img: [
            "static/ico/coffee_bean.png",
            "static/ico/delete.png",
          ],
        },
      ],
      Endulzante: [
        {
          value: "Az. Blanco",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/azucar-blanco.jpg",
          ],
        },
        {
          value: "Az. Moreno",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/azucar-moreno.png",
          ],
        },
        {
          value: "Sacarina",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/sacarina.jpg",
          ],
        },
        {
          value: "Stevia (Pastillas)",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/stevia.jpg",
          ],
        },
        {
          value: "Stevia (Gotas)",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/stevia-gotas.webp",
          ],
        },
        {
          value: "Sin",
          key: "Endulzante",
          className: "btn6",
          img: [
            "static/ico/delete.png",
          ],
        },
      ],
      Receta: [
        {
          value: "Si",
          key: "Receta",
          className: "btn7",
          img: [
            "static/ico/add.png",
          ],
        },
        {
          value: "No",
          key: "Receta",
          className: "btn7",
          img: [
            "static/ico/delete.png",
          ],
        },
      ],
    };
    var SC_Personas = {};
    // Listado precargado de personas:
    gun
      .get(TABLE)
      .get("personas")
      .map()
      .on((data, key, _msg, _ev) => {
        if (data != null) {
          function add_row(data, key) {
            if (data != null) {
              data["_key"] = key;
              SC_Personas[key] = data;
            } else {
              delete SC_Personas[key];
            }
          }
          if (typeof data == "string") {
            SEA.decrypt(data, SECRET, (data) => {
              add_row(data, key);
            });
          } else {
            add_row(data, key);
          }
        }
      });

    function SC_parse(json) {
      var out = "";
      Object.entries(json).forEach((entry) => {
        out += entry[0] + ": " + entry[1] + "\n";
      });
      return out;
    }
    function SC_priceCalc(json) {
      var precio = 0;
      var valores = "";
      // Servicio base = 10c
      precio += 10;
      valores += "Servicio base = 10c\n";
      // Leche pequeña = 10c
      if (
        json["Tamaño"] == "Pequeño" &&
        ["de Vaca", "Sin lactosa", "Vegetal"].includes(json["Leche"])
      ) {
        precio += 10;
        valores += "Leche pequeña = 10c\n";
      }
      // Leche grande = 20c
      if (
        json["Tamaño"] == "Grande" &&
        ["de Vaca", "Sin lactosa", "Vegetal"].includes(json["Leche"])
      ) {
        precio += 20;
        valores += "Leche grande = 20c\n";
      }
      // Café = 20c
      if (
        ["Café con leche", "Solo café (sin leche)"].includes(
          json["Selección"]
        )
      ) {
        precio += 20;
        valores += "Café = 20c\n";
      }
      // ColaCao = 20c
      if (json["Selección"] == "ColaCao con leche") {
        precio += 20;
        valores += "ColaCao = 20c\n";
      }
      valores += "<hr>Total: " + precio + "c\n";
      return precio, valores;
    }
    function PERSONAS_Sorter(a, b) {
      if (a[1].Region < b[1].Region) {
        return -1;
      }
      if (a[1].Region > b[1].Region) {
        return 1;
      }
      return 0;
    }
    const PAGES = {
      index: {
        //navcss: "btn1",
        Title: "Inicio",
        index: function () {
          container.innerHTML = `
                <h1>Inicio</h1>
                <em>Utiliza el menú superior para abrir un modulo</em>
            `;
        },
      },

      importar: {
        navcss: "btn1",
        Title: "Importar",
        index: function () {
          var select_type = safeuuid();
          var textarea_content = safeuuid();
          var button_import = safeuuid();
          var button_clear = safeuuid();
          container.innerHTML = `
                <h1>Importar Datos</h1>
                <fieldset>
                    <legend>Importar datos</legend>
                    <em>Espera hasta que se vacien todas las notificaciones.</em>
                    <select id="${select_type}">
                        <option value="" disabled selected>Tipo de archivo...</option>
                        <option value="comedor">Galileo - db.comedor.axd</option>
                        <option value="recetas">Galileo - db.recetas.axd</option>
                        <option value="materiales">Galileo - db.materiales.axd</option>
                        <option value="personas">Galileo - db.personas.axd</option>
                        <option value="comandas">Galileo - db.cafe.comandas.axd</option>
                        <option value="%telesec">TeleSec Exportado (encriptado o no)</option>
                    </select>
                    <textarea id="${textarea_content}" style="height: 100px;" placeholder="Introduce el contenido del archivo"></textarea>
                    <button id="${button_import}" type="button">Importar</button>
                    <button id="${button_clear}" type="button">Vaciar</button>
                </fieldset>
            `;
          document.getElementById(button_import).onclick = () => {
            toastr.info("Importando datos...");
            var val = document.getElementById(textarea_content).value;
            var sel = document.getElementById(select_type).value;
            if (sel == "%telesec") {
              gun.get(TABLE).put(JSON.parse(val), (ack) => {
                toastr.info("Importado " + entry[0] + ".");
              });
            } else {
              Object.entries(JSON.parse(val)["data"]).forEach((entry) => {
                var enc = SEA.encrypt(entry[1], SECRET, (encrypted) => {
                  betterGunPut(
                    gun.get(TABLE).get(sel).get(entry[0]),
                    encrypted
                  );
                });
              });
            }
            setTimeout(() => {
              toastr.info("Importado todo!");

              if (sel == "%telesec") {
                setUrlHash("inicio");
              } else {
                setUrlHash(sel);
              }
            }, 5000);
          };
        },
      },
      exportar: {
        navcss: "btn1",
        Title: "Exportar",
        index: function () {
          var select_type = safeuuid();
          var textarea_content = safeuuid();
          var button_export_local = safeuuid();
          var button_export_safe = safeuuid();
          var button_export_safe_cloud = safeuuid();
          var button_clear = safeuuid();
          container.innerHTML = `
                <h1>Exportar Datos</h1>
                <fieldset>
                    <legend>Exportar datos</legend>
                    <em>Al pulsar, Espera hasta que salga una notificacion verde.</em>
                    <br>
                    <br>
                    <button id="${button_export_local}" type="button">Exportar sin cifrar</button>
                    <button id="${button_export_safe}" type="button">Exportar con cifrado</button>
                    <button id="${button_export_safe_cloud}" style="display: none;" type="button">Exportar a EuskadiTech - cifrado</button>
                    <br><br><em>Para descargar envia un correo a telesec@tech.eus con el asunto "TSBK %${GROUPID}".</em>
                </fieldset>
            `;
          document.getElementById(button_export_local).onclick = () => {
            var data_export = {};
            var output = {
              materiales: {},
              personas: {},
            };
            var download_data = (DATA) => {
              Object.keys(DATA).forEach((modul) => {
                Object.entries(DATA[modul] || {}).forEach((entry) => {
                  var key = entry[0];
                  var value = entry[1];
                  if (value != null) {
                    if (typeof value == "string") {
                      SEA.decrypt(value, SECRET, (data) => {
                        output[modul][key] = data;
                      });
                    } else {
                      output[modul][key] = value;
                    }
                  }
                });
                toastr.success("Exportado todo, descargando!");
                console.error(output);
                download(
                  `Export TeleSec ${GROUPID}.json.txt`,
                  JSON.stringify(output)
                );
                //setUrlHash(sel);
              }, 2500);
            };
            gun.get(TABLE).load(download_data);
          };
          document.getElementById(button_export_safe).onclick = () => {
            var download_data = (DATA) => {
              toastr.success("Exportado todo, descargado!");
              console.error(DATA);
              download(
                `Export TeleSec Encriptado ${GROUPID}.json.txt`,
                JSON.stringify(DATA)
              );
              //setUrlHash(sel);
            };
            gun.get(TABLE).load(download_data);
          };
          document.getElementById(button_export_safe_cloud).onclick = () => {
            var download_data = (DATA) => {
              toastr.info("Exportado todo, subiendo!");
              console.error(DATA);
              fetch(
                "https://telesec-sync.tech.eus/upload_backup.php?table=" +
                GROUPID,
                {
                  method: "POST",
                  body: JSON.stringify(DATA),
                }
              )
                .then(() => {
                  toastr.success("Subido correctamente!");
                })
                .catch(() => {
                  toastr.error("Ha ocurrido un error en la subida.");
                });
            };
            gun.get(TABLE).load(download_data);
          };
        },
      },
      materiales: {
        navcss: "btn2",
        Title: "Materiales",
        edit: function (mid) {
          var nameh1 = safeuuid();
          var field_nombre = safeuuid();
          var field_cantidad = safeuuid();
          var field_unidad = safeuuid();
          var field_cantidad_min = safeuuid();
          var field_abierto = safeuuid();
          var field_ubicacion = safeuuid();
          var field_referencia = safeuuid();
          var field_notas = safeuuid();
          var btn_guardar = safeuuid();
          var btn_borrar = safeuuid();
          container.innerHTML = `
                <h1>Material <code id="${nameh1}"></code></h1>
                <fieldset>
                    <label>
                        Referencia<br>
                        <input type="text" id="${field_referencia}" value="?"><br><br>
                    </label>
                    <label>
                        Nombre<br>
                        <input type="text" id="${field_nombre}"><br><br>
                    </label>
                    <label>
                        Unidad<br>
                        <input type="text" id="${field_unidad}"><br><br>
                    </label>
                    <label>
                        Cantidad Actual<br>
                        <input type="number" step="0.5" id="${field_cantidad}"><br><br>
                    </label>
                    <label>
                        Cantidad Minima<br>
                        <input type="number" step="0.5" id="${field_cantidad_min}"><br><br>
                    </label>
                    <label>
                        Ubicación<br>
                        <input type="text" id="${field_ubicacion}" value="-"><br><br>
                    </label>
                    <label>
                        Notas<br>
                        <textarea id="${field_notas}"></textarea><br><br>
                    </label><hr>
                    <button class="btn5" id="${btn_guardar}">Guardar</button>
                    <button class="rojo" id="${btn_borrar}">Borrar</button>
                </fieldset>
                `;
          gun
            .get(TABLE)
            .get("materiales")
            .get(mid)
            .once((data, key) => {
              function load_data(data, ENC = "") {
                document.getElementById(nameh1).innerText = key;
                document.getElementById(field_nombre).value =
                  data["Nombre"] || "";
                document.getElementById(field_unidad).value =
                  data["Unidad"] || "";
                document.getElementById(field_cantidad).value =
                  data["Cantidad"] || "";
                document.getElementById(field_cantidad_min).value =
                  data["Cantidad_Minima"] || "";
                document.getElementById(field_ubicacion).value =
                  data["Ubicacion"] || "-";
                document.getElementById(field_referencia).value =
                  data["Referencia"] || "?";
                document.getElementById(field_notas).value =
                  data["Notas"] || "";
              }
              if (typeof data == "string") {
                SEA.decrypt(data, SECRET, (data) => {
                  load_data(data, "%E");
                });
              } else {
                load_data(data);
              }
            });
          document.getElementById(btn_guardar).onclick = () => {
            var data = {
              Nombre: document.getElementById(field_nombre).value,
              Unidad: document.getElementById(field_unidad).value,
              Cantidad: document.getElementById(field_cantidad).value,
              Cantidad_Minima:
                document.getElementById(field_cantidad_min).value,
              Ubicacion: document.getElementById(field_ubicacion).value,
              Referencia: document.getElementById(field_referencia).value,
              Notas: document.getElementById(field_notas).value,
            };
            var enc = SEA.encrypt(data, SECRET, (encrypted) => {
              document.getElementById("actionStatus").style.display = "block"
              betterGunPut(
                gun.get(TABLE).get("materiales").get(mid),
                encrypted
              );
              toastr.success("Guardado!");
              setTimeout(() => {
                document.getElementById("actionStatus").style.display = "none"
                setUrlHash("materiales");
              }, 1500);
            });
          };
          document.getElementById(btn_borrar).onclick = () => {
            if (confirm("¿Quieres borrar este material?") == true) {
              betterGunPut(gun.get(TABLE).get("materiales").get(mid), null);
              toastr.error("Borrado!");
              setTimeout(() => {
                setUrlHash("materiales");
              }, 1500);
            }
          };
        },
        index: function () {
          const tablebody = safeuuid();
          var btn_new = safeuuid();
          container.innerHTML = `
                <h1>Materiales</h1>
                <button id="${btn_new}">Nuevo Material</button>
                <div id="scrolltable"><table>
                    <thead>
                        <tr>
                            <th>Referencia</th>
                            <th>Nombre</th>
                            <th>Ubicación</th>
                            <th>Cantidad</th>
                            <th>Notas</th>
                        </tr>
                    </thead>
                    <tbody id="${tablebody}">
                    </tbody>
                </table></div>
                `;
          tableScroll("#scrolltable")
          var tablebody_EL = document.getElementById(tablebody);
          var rows = {};
          function render() {
            function sorter(a, b) {
              if (a.Nombre < b.Nombre) {
                return -1;
              }
              if (a.Nombre > b.Nombre) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(tablebody);
            tablebody_EL.innerHTML = "";
            Object.values(rows)
              .sort(sorter)
              .forEach((data) => {
                var new_tr = document.createElement("tr");
                new_tr.innerHTML = `
                    <td>${data.Referencia || "?"}</td>
                    <td>${data.Nombre || "?"}</td>
                    <td>${data.Ubicacion || "?"}</td>
                    <td>${data.Cantidad || "?"} ${data.Unidad || "?"}</td>
                    <td>${data.Notas || "?"}</td>
                    `;
                var min = parseFloat(data.Cantidad_Minima);
                var act = parseFloat(data.Cantidad);
                if (act < min) {
                  new_tr.style.backgroundColor = "lightcoral";
                }
                new_tr.onclick = () => {
                  setUrlHash("materiales," + data._key);
                };
                tablebody_EL.append(new_tr);
              });
          }
          gun
            .get(TABLE)
            .get("materiales")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER = _ev;
              if (data != null) {
                function add_row(data, key) {
                  if (data != null) {
                    data["_key"] = key;
                    rows[key] = data;
                  } else {
                    delete rows[key];
                  }
                  render();
                }
                if (typeof data == "string") {
                  SEA.decrypt(data, SECRET, (data) => {
                    add_row(data, key);
                  });
                } else {
                  add_row(data, key);
                }
              }
            });
          document.getElementById(btn_new).onclick = () => {
            setUrlHash("materiales," + safeuuid(""));
          };
        },
      },
      resumen_diario: {
        navcss: "btn3",
        Title: "Resumen Semanal",
        index: function () {
          var table_materialesLow = safeuuid();
          var table_personasHigh = safeuuid();
          container.innerHTML = `
                <h1>Resumen Semanal</h1>
                <h2>Personas con café gratis (para el Viernes)</h2>
                <div id="${table_personasHigh}"></div>
                <h2>Materiales faltantes (o por llegar)</h2>
                <div id="${table_materialesLow}"></div>
            `;
          var materiales_low = {};
          var personas_high = {};
          function render_materialesLow() {
            function sorter(a, b) {
              if (a.Nombre < b.Nombre) {
                return -1;
              }
              if (a.Nombre > b.Nombre) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(table_materialesLow);
            tablebody_EL.innerHTML = "";
            Object.values(materiales_low)
              .sort(sorter)
              .forEach((data) => {
                var min = parseFloat(data.Cantidad_Minima);
                var act = parseFloat(data.Cantidad);
                var falta = min - act;
                if (act < min) {
                  var new_tr = document.createElement("span");
                  new_tr.innerHTML = `<b>${data.Nombre || "?"
                    }</b><br>Faltan ${falta || "?"} ${data.Unidad || "?"
                    } <br><i style="font-size: 75%">${data.Ubicacion || "?"
                    }</i>`;
                  new_tr.className = PAGES["materiales"].navcss;
                  new_tr.style.display = "inline-block";
                  new_tr.style.margin = "5px";
                  new_tr.style.padding = "5px";
                  new_tr.style.borderRadius = "5px";
                  new_tr.style.border = "2px solid black";
                  new_tr.style.cursor = "pointer";
                  new_tr.onclick = () => {
                    setUrlHash("materiales," + data._key);
                  };
                  tablebody_EL.append(new_tr);
                }
              });
          }
          gun
            .get(TABLE)
            .get("materiales")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER2 = _ev;
              if (data != null) {
                function add_row(data, key) {
                  if (data != null) {
                    data["_key"] = key;
                    materiales_low[key] = data;
                  } else {
                    delete materiales_low[key];
                  }
                  render_materialesLow();
                }
                if (typeof data == "string") {
                  SEA.decrypt(data, SECRET, (data) => {
                    add_row(data, key);
                  });
                } else {
                  add_row(data, key);
                }
              }
            });
          function render_personasHigh() {
            function sorter(a, b) {
              if (a.Nombre < b.Nombre) {
                return -1;
              }
              if (a.Nombre > b.Nombre) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(table_personasHigh);
            tablebody_EL.innerHTML = "";
            Object.values(personas_high)
              .sort(sorter)
              .forEach((data) => {
                if (data.Puntos >= 10) {
                  var new_tr = document.createElement("span");
                  new_tr.innerHTML = `<img src="${data.Foto || ""
                    }" alt="" height="55" style="float: left; margin-right: 5px;"><b>${data.Nombre || "?"
                    }</b><br>Tiene ${data.Puntos || "?"
                    } puntos <br><i style="font-size: 75%">${data.Region || "?"
                    }</i>`;
                  new_tr.className = PAGES["personas"].navcss;
                  new_tr.style.display = "inline-block";
                  new_tr.style.margin = "5px";
                  new_tr.style.padding = "5px";
                  new_tr.style.borderRadius = "5px";
                  new_tr.style.border = "2px solid black";
                  new_tr.style.cursor = "pointer";
                  new_tr.style.width = "200px";

                  new_tr.onclick = () => {
                    setUrlHash("personas," + data._key);
                  };
                  tablebody_EL.append(new_tr);
                }
              });
          }
          gun
            .get(TABLE)
            .get("personas")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER = _ev;
              if (data != null) {
                function add_row(data, key) {
                  if (data != null) {
                    data["_key"] = key;
                    personas_high[key] = data;
                  } else {
                    delete personas_high[key];
                  }
                  render_personasHigh();
                }
                if (typeof data == "string") {
                  SEA.decrypt(data, SECRET, (data) => {
                    add_row(data, key);
                  });
                } else {
                  add_row(data, key);
                }
              }
            });
        },
      },
      personas: {
        navcss: "btn4",
        Title: "Personas",
        edit: function (mid) {
          var nameh1 = safeuuid();
          var field_nombre = safeuuid();
          var field_zona = safeuuid();
          var field_roles = safeuuid();
          var field_puntos = safeuuid();
          var field_notas = safeuuid();
          var field_anilla = safeuuid();
          var field_foto = safeuuid();
          var render_foto = safeuuid();
          var btn_guardar = safeuuid();
          var btn_borrar = safeuuid();
          container.innerHTML = `
                <h1>Persona <code id="${nameh1}"></code></h1>
                <fieldset>
                    <label>
                        Nombre<br>
                        <input type="text" id="${field_nombre}"><br><br>
                    </label>
                    <label>
                        Zona<br>
                        <input type="text" id="${field_zona}"><br><br>
                    </label>
                    <label>
                        Permisos<br>
                        <input type="text" id="${field_roles}"><br><br>
                    </label>
                    <label>
                        Puntos<br>
                        <input type="number" id="${field_puntos}"><br><br>
                    </label>
                    <label>
                        Anilla<br>
                        <input type="color" id="${field_anilla}"><br><br>
                    </label>
                    <label>
                        Foto (PNG o JPG)<br>
                        <img id="${render_foto}" height="100px" style="border: 3px inset; min-width: 7px;" src="static/camera2.png">
                        <input type="file" accept="image/*" id="${field_foto}" style="display: none;"><br><br>
                    </label>


                    <label>
                        Notas<br>
                        <textarea id="${field_notas}"></textarea><br><br>
                    </label><hr>
                    <button class="btn5" id="${btn_guardar}">Guardar</button>
                    <button class="rojo" id="${btn_borrar}">Borrar</button>
                </fieldset>
                `;
          var resized = "";
          gun
            .get(TABLE)
            .get("personas")
            .get(mid)
            .once((data, key) => {
              function load_data(data, ENC = "") {
                document.getElementById(nameh1).innerText = key;
                document.getElementById(field_nombre).value =
                  data["Nombre"] || "";
                document.getElementById(field_zona).value =
                  data["Region"] || "";
                document.getElementById(field_roles).value =
                  data["Roles"] || "";
                document.getElementById(field_puntos).value =
                  data["Puntos"] || 0;
                document.getElementById(field_anilla).value =
                  data["SC_Anilla"] || "";
                // document.getElementById(field_foto).value = "";
                document.getElementById(render_foto).src =
                  data["Foto"] ||
                  "static/ico/user_generic.png";
                resized =
                  data["Foto"] ||
                  "static/ico/user_generic.png";
                document.getElementById(field_notas).value =
                  data["markdown"] || "";
              }
              if (typeof data == "string") {
                SEA.decrypt(data, SECRET, (data) => {
                  load_data(data, "%E");
                });
              } else {
                load_data(data);
              }
            });
          document
            .getElementById(field_foto)
            .addEventListener("change", function (e) {
              const file = e.target.files[0];
              if (!file) return;

              resizeInputImage(
                file,
                function (url) {
                  console.log(url);
                  document.getElementById(render_foto).src = url;
                  resized = url;
                },
                125,
                0.7
              );
            });
          document.getElementById(btn_guardar).onclick = () => {
            var data = {
              Nombre: document.getElementById(field_nombre).value,
              Region: document.getElementById(field_zona).value,
              Roles: document.getElementById(field_roles).value,
              Puntos: document.getElementById(field_puntos).value,
              SC_Anilla: document.getElementById(field_anilla).value,
              Foto: resized,
              markdown: document.getElementById(field_notas).value,
            };
            var enc = SEA.encrypt(data, SECRET, (encrypted) => {
              document.getElementById("actionStatus").style.display = "block"
              betterGunPut(
                gun.get(TABLE).get("personas").get(mid),
                encrypted
              );
              toastr.success("Guardado!");
              setTimeout(() => {
                document.getElementById("actionStatus").style.display = "none"
                setUrlHash("personas");
              }, 1500);
            });
          };
          document.getElementById(btn_borrar).onclick = () => {
            if (confirm("¿Quieres borrar esta persona?") == true) {
              betterGunPut(gun.get(TABLE).get("personas").get(mid), null);
              toastr.error("Borrado!");
              setTimeout(() => {
                setUrlHash("personas");
              }, 1500);
            }
          };
        },
        index: function () {
          const tablebody = safeuuid();
          var btn_new = safeuuid();
          container.innerHTML = `
                <h1>Personas</h1>
                <button id="${btn_new}">Nueva Persona</button>
                <div id="scrolltable"><table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Zona</th>
                            <th>Puntos</th>
                            <th>Permisos</th>
                        </tr>
                    </thead>
                    <tbody id="${tablebody}">
                    </tbody>
                </table></div>
                `;
          tableScroll("#scrolltable") // id="scrolltable"
          var tablebody_EL = document.getElementById(tablebody);
          var rows = {};
          function render() {
            function sorter(a, b) {
              if (a.Region.toUpperCase() < b.Region.toUpperCase()) {
                return -1;
              }
              if (a.Region.toUpperCase() > b.Region.toUpperCase()) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(tablebody);
            tablebody_EL.innerHTML = "";
            // SC_Personas = rows
            Object.values(rows)
              .sort(sorter)
              .forEach((data) => {
                var btn_comanda = safeuuid();
                var new_tr = document.createElement("tr");
                new_tr.innerHTML = `
                    <td class="TextBorder" style="background-color: ${data.SC_Anilla
                  }; text-align: center"><img src="${data.Foto ||
                  "static/ico/user_generic.png"
                  }" height="50"> <br> ${data.Nombre || ""}</td>
                    <td>${data.Region || "?"}</td>
                    <td>${data.Puntos || 0}</td>
                    <td>${data.Roles || ""}</td>
                    `;

                // <button id="${btn_comanda}" class="${PAGES.ventas.navcss}">Nueva venta</button>
                var act = parseFloat(data.Puntos);
                if (act >= 10) {
                  new_tr.style.backgroundColor = "gold";
                }
                new_tr.onclick = () => {
                  setUrlHash("personas," + data._key);
                };
                tablebody_EL.append(new_tr);
                // document.getElementById(btn_comanda).onclick = (e) => {
                //   setUrlHash("ventas," + data._key);
                //   if (!e) var e = window.event;
                //   e.cancelBubble = true;
                //   if (e.stopPropagation) e.stopPropagation();
                // };
              });
          }
          gun
            .get(TABLE)
            .get("personas")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER = _ev;
              if (data != null) {
                function add_row(data, key) {
                  if (data != null) {
                    data["_key"] = key;
                    rows[key] = data;
                  } else {
                    delete rows[key];
                  }
                  render();
                }
                if (typeof data == "string") {
                  SEA.decrypt(data, SECRET, (data) => {
                    add_row(data, key);
                  });
                } else {
                  add_row(data, key);
                }
              }
            });
          document.getElementById(btn_new).onclick = () => {
            setUrlHash("personas," + safeuuid(""));
          };
        },
      },
      supercafe: {
        navcss: "btn5",
        Title: "SuperCafé",
        edit: function (mid) {
          var nameh1 = safeuuid();
          var field_fecha = safeuuid();
          var field_persona = safeuuid();
          var field_comanda = safeuuid();
          var field_notas = safeuuid();
          var field_estado = safeuuid();
          var div_actions = safeuuid();
          var btn_pagos = safeuuid();
          var btn_cocina = safeuuid();
          var btn_guardar = safeuuid();
          var btn_guardar2 = safeuuid();
          var btn_borrar = safeuuid();
          container.innerHTML = `
                <h1>Comanda <code id="${nameh1}"></code></h1>
                <button onclick="setUrlHash('supercafe');">Salir</button>
                <fieldset style="text-align: center;">
                    <legend>Rellenar comanda</legend>
                    <label style="display: none;">
                        Fecha<br>
                        <input readonly disabled type="text" id="${field_fecha}" value="${CurrentISODate()}"><br><br>
                    </label>
                    <label style="display: none;">
                        Persona<br>
                        <input type="hidden" id="${field_persona}">
                        <br><br>
                    </label>
                    <label style="display: none;">
                        Comanda (utiliza el panel de relleno)<br>
                        <textarea readonly disabled id="${field_comanda}"></textarea><br><br>
                    </label>
                    <div id="${div_actions}" open>
                      <!--<summary>Mostrar botones de relleno</summary>-->
                    </div>
                    <label>
                        Notas<br>
                        <textarea id="${field_notas}"></textarea><br><br>
                    </label>
                    <label style="display: none;">
                        Estado<br>
                        <input readonly disabled type="text" id="${field_estado}" value="%%">
                        <br>Modificar en el listado de comandas<br>
                    </label>
                    <button id=${btn_guardar} class="btn5">Guardar</button>
                    <button id=${btn_borrar} class="rojo">Borrar</button>
                </fieldset>
                `;
          var currentData = {};
          var currentPersonaID = "";
          var divact = document.getElementById(div_actions);

          function loadActions() {
            divact.innerHTML = "";
            addCategory_Personas(
              divact,
              SC_Personas,
              currentPersonaID,
              (value) => {
                document.getElementById(field_persona).value = value;
              }
            );
            Object.entries(SC_actions).forEach((category) => {
              addCategory(
                divact,
                category[0],
                SC_actions_icons[category[0]],
                category[1],
                currentData,
                (values) => {
                  document.getElementById(field_comanda).value =
                    SC_parse(values);
                }
              );
            });
          }
          loadActions();
          gun
            .get(TABLE)
            .get("supercafe")
            .get(mid)
            .once((data, key) => {
              function load_data(data, ENC = "") {
                document.getElementById(nameh1).innerText = key;
                document.getElementById(field_fecha).value = data["Fecha"];
                document.getElementById(field_persona).value =
                  data["Persona"] || "";
                currentPersonaID = data["Persona"] || "";
                document.getElementById(field_comanda).value =
                  SC_parse(JSON.parse(data["Comanda"] || "{}")) || "";
                document.getElementById(field_notas).value =
                  data["Notas"] || "";
                document.getElementById(field_estado).value =
                  data["Estado"] || "";
                currentData = JSON.parse(data["Comanda"] || "{}");

                loadActions();
              }
              if (typeof data == "string") {
                SEA.decrypt(data, SECRET, (data) => {
                  load_data(data, "%E");
                });
              } else {
                load_data(data);
              }
            });
          document.getElementById(btn_guardar).onclick = () => {
            if (document.getElementById(field_persona).value == "") {
              alert("¡Hay que elegir una persona!");
              return;
            }
            var data = {
              Fecha: document.getElementById(field_fecha).value,
              Persona: document.getElementById(field_persona).value,
              Comanda: JSON.stringify(currentData),
              Notas: document.getElementById(field_notas).value,
              Estado: document
                .getElementById(field_estado)
                .value.replace("%%", "Pedido"),
            };
            var enc = SEA.encrypt(data, SECRET, (encrypted) => {
              document.getElementById("actionStatus").style.display = "block"
              betterGunPut(
                gun.get(TABLE).get("supercafe").get(mid),
                encrypted
              );
              toastr.success("Guardado!");
              setTimeout(() => {
                document.getElementById("actionStatus").style.display = "none"
                setUrlHash("supercafe");
              }, 1500);
            });
          };
          document.getElementById(btn_borrar).onclick = () => {
            if (
              confirm(
                "¿Quieres borrar esta comanda? - NO se actualizaran los puntos de la persona asignada."
              ) == true
            ) {
              betterGunPut(gun.get(TABLE).get("supercafe").get(mid), null);
              setTimeout(() => {
                setUrlHash("supercafe");
              }, 1500);
            }
          };
        },
        index: function () {
          var tts = false;
          setTimeout(() => {tts = true}, 7500)
          const tablebody = safeuuid();
          var btn_new = safeuuid();
          container.innerHTML = `
                <h1>SuperCafé</h1>
                <button id="${btn_new}">Nueva comanda</button>
                <div id="scrolltable"><table>
                    <thead>
                        <tr>
                          <th>Zona</th>
                          <th>Persona</th>
                          <th>Estado</th>
                          <th>Comanda</th>
                          <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="${tablebody}">
                    </tbody>
                </table></div>
                `;

          tableScroll("#scrolltable") // id="scrolltable"
          var tablebody_EL = document.getElementById(tablebody);
          var rows2 = {};
          function render() {
            function sorter(a, b) {
              if (
                SC_Personas[a.Persona].Region.toUpperCase() <
                SC_Personas[b.Persona].Region.toUpperCase()
              ) {
                return -1;
              }
              if (
                SC_Personas[a.Persona].Region.toUpperCase() >
                SC_Personas[b.Persona].Region.toUpperCase()
              ) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(tablebody);
            tablebody_EL.innerHTML = "";
            var DefaultPersona = {
              Foto: "static/ico/user_generic.png",
              Nombre: "Desconocido??",
              Puntos: "1",
              Region: "SIN AULA",
              Roles: "Cafe_SiCaf",
              SC_Anilla: "#000000",
              markdown: "Fantasma",
              _key: "135733281028030249",
            };
            Object.values(rows2)
              .sort(sorter)
              .forEach((data) => {
                var btn_Pedido = safeuuid();
                var btn_Preparacion = safeuuid();
                var btn_Hecho = safeuuid();
                var btn_Entregado = safeuuid();
                var btn_Pagado = safeuuid();
                var span_precio = safeuuid();
                var persona = SC_Personas[data.Persona] || DefaultPersona;
                var new_tr = document.createElement("tr");
                var precio,
                  resumen = SC_priceCalc(JSON.parse(data.Comanda));
                if (persona == DefaultPersona) {
                  data.Persona = "135733281028030249";
                }
                new_tr.innerHTML = `
                  <td>${persona.Region.toUpperCase() || "?"}</td>
                  <td class="TextBorder" style="background-color: ${persona.SC_Anilla
                  }; text-align: center; font-size: 17px;"><img src="${persona.Foto ||
                  "static/ico/user_generic.png"
                  }" height="50"><br> ${persona.Nombre || ""
                  }<br> <span style="font-size: 25px;">${persona.Puntos || "0"
                  } pts.</span></td>
                        <td style="font-size: 17px;">
                          <button id="${btn_Pedido}" class="">Pedido</button>
                          <br><button id="${btn_Preparacion}" class="">En preparación</button>
                          <br><button id="${btn_Hecho}" class="">Hecho</button>
                          <br><button id="${btn_Entregado}" class="">Entregado</button>
                          <br><button id="${btn_Pagado}" class="">Pagado</button></td>
                        <td><pre style="font-size: 17px;">${SC_parse(JSON.parse(data.Comanda)) +
                  "<hr>" +
                  data.Notas
                  }</pre></td>
                        <td><pre>${resumen}</pre><span style="font-size: 20px;" id="${span_precio}"></span></td>
                        `;
                tablebody_EL.append(new_tr);
                if (data.Estado == "Pedido") {
                  document.getElementById(btn_Pedido).classList = "rojo";
                }
                if (data.Estado == "En preparación") {
                  document.getElementById(btn_Preparacion).classList = "rojo";
                  new_tr.style.backgroundColor = "#FFCCCB";
                }
                if (data.Estado == "Hecho") {
                  new_tr.style.backgroundColor = "gold";
                  document.getElementById(btn_Hecho).classList = "rojo";
                }
                if (data.Estado == "Entregado") {
                  document.getElementById(btn_Entregado).classList = "rojo";
                  new_tr.style.backgroundColor = "lightgreen";
                }
                new_tr.onclick = () => {
                  setUrlHash("supercafe," + data._key);
                };
                if (SC_Personas[data.Persona].Puntos >= 10) {
                  document.getElementById(span_precio).innerHTML =
                    "Gratis!<br> Usando puntos";
                }
                // Acciónes
                document.getElementById(btn_Pedido).onclick = () => {
                  window.event.cancelBubble = true;
                  window.event.stopPropagation();
                  data.Estado = "Pedido";
                  var enc = SEA.encrypt(data, SECRET, (encrypted) => {
                    betterGunPut(
                      gun.get(TABLE).get("supercafe").get(data._key),
                      encrypted
                    );
                    toastr.success("Guardado!");
                  });
                };
                document.getElementById(btn_Preparacion).onclick = () => {
                  window.event.cancelBubble = true;
                  window.event.stopPropagation();
                  data.Estado = "En preparación";
                  var enc = SEA.encrypt(data, SECRET, (encrypted) => {
                    betterGunPut(
                      gun.get(TABLE).get("supercafe").get(data._key),
                      encrypted
                    );
                    toastr.success("Guardado!");
                  });
                };
                document.getElementById(btn_Hecho).onclick = () => {
                  window.event.cancelBubble = true;
                  window.event.stopPropagation();
                  data.Estado = "Hecho";
                  var enc = SEA.encrypt(data, SECRET, (encrypted) => {
                    betterGunPut(
                      gun.get(TABLE).get("supercafe").get(data._key),
                      encrypted
                    );
                    toastr.success("Guardado!");
                  });
                };
                document.getElementById(btn_Entregado).onclick = () => {
                  window.event.cancelBubble = true;
                  window.event.stopPropagation();
                  data.Estado = "Entregado";
                  var enc = SEA.encrypt(data, SECRET, (encrypted) => {
                    betterGunPut(
                      gun.get(TABLE).get("supercafe").get(data._key),
                      encrypted
                    );
                    toastr.success("Guardado!");
                  });
                };
                document.getElementById(btn_Pagado).onclick = () => {
                  window.event.cancelBubble = true;
                  window.event.stopPropagation();
                  if (!confirm("¿Quieres marcar como pagado? - Se borrara la comanda y se actualizarán los puntos.")) {return}
                  data.Estado = "Pagado";
                  betterGunPut(
                    gun.get(TABLE).get("supercafe").get(data._key),
                    null
                  );
                  //setUrlHash("personas");
                  //setUrlHash("supercafe");
                  toastr.success("Guardado!");
                  if (SC_Personas[data.Persona].Puntos >= 10) {
                    SC_Personas[data.Persona].Puntos -= 10;
                    toastr.success(
                      "¡Comada gratis para " +
                      SC_Personas[data.Persona].Nombre +
                      "!"
                    );
                    toastr.success(
                      "¡Comada gratis para " +
                      SC_Personas[data.Persona].Nombre +
                      "!"
                    );
                  } else {
                    SC_Personas[data.Persona].Puntos += 1;
                    toastr.success("¡Comada DE PAGO!");
                  }
                  SEA.encrypt(
                    SC_Personas[data.Persona],
                    SECRET,
                    (encrypted) => {
                      betterGunPut(
                        gun.get(TABLE).get("personas").get(data.Persona),
                        encrypted
                      );
                    }
                  );
                };
              });
          }
          var old = {};
          gun
            .get(TABLE)
            .get("supercafe")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER = _ev;
              //alert("sc_map_on")
              function add_row(data, key) {
                if (data != null) {
                  data["_key"] = key;
                  console.log(old[key], data.Estado)
                  if (old[key] == undefined) {
                    old[key] = "";
                  }
                  if (old[key] != data.Estado) {
                    console.log("SC:Updated:", data)
                    if (tts) {
                      var msg = `Comanda de ${SC_Personas[data.Persona].Region}. ${SC_Personas[data.Persona].Nombre}. ${data.Estado}`
                      let utterance = new SpeechSynthesisUtterance(msg);
                      utterance.rate = 0.9
                      utterance.voice = speechSynthesis.getVoices()[7]
                      speechSynthesis.speak(utterance);
                    }
                  }
                  rows2[key] = data;
                  old[key] = data.Estado;
                } else {
                  // console.log("delete", key);
                  delete rows2[key];
                  delete old[key];
                }
                render();
              }
              if (typeof data == "string") {
                SEA.decrypt(data, SECRET, (data) => {
                  add_row(data, key);
                });
              } else {
                add_row(data, key);
              }
            });
          document.getElementById(btn_new).onclick = () => {
            setUrlHash("supercafe," + safeuuid(""));
          };
        },
      },
      notificaciones: {
        navcss: "btn6",
        Title: "Notificaciones",
        edit: function (mid) {
          var nameh1 = safeuuid();
          var field_fecha = safeuuid();
          var field_asunto = safeuuid();
          var field_origen = safeuuid();
          var field_destino = safeuuid();
          var field_estado = safeuuid();
          var field_mensaje = safeuuid();
          var btn_leer = safeuuid();
          var btn_desleer = safeuuid();
          var btn_guardar = safeuuid();
          var btn_borrar = safeuuid();
          container.innerHTML = `
                <h1>Notificación <code id="${nameh1}"></code></h1>
                <fieldset style="float: left;">
                    <legend>Valores</legend>
                    <label>
                        Fecha<br>
                        <input readonly disabled type="text" id="${field_fecha}" value="${CurrentISODate()}"><br><br>
                    </label>
                    <label>
                        Asunto<br>
                        <input type="text" id="${field_asunto}" value=""><br><br>
                    </label>
                    <label>
                        Origen<br>
                        <select id="${field_origen}">
                          <option value="" disabled selected>Selecciona una persona...</option>
                          ${Object.entries(SC_Personas)
              .sort(PERSONAS_Sorter)
              .map((entry) => {
                return `<option value="${entry[0]}">${entry[1].Nombre || "?"
                  }</option>`;
              })
              .join("")}
                        </select><br><br>

                    </label>
                    <label>
                        Destino<br>
                        <select id="${field_destino}">
                          <option value="" disabled selected>Selecciona una persona...</option>
                          ${Object.entries(SC_Personas)
              .sort(PERSONAS_Sorter)
              .map((entry) => {
                return `<option value="${entry[0]}">${entry[1].Nombre || "?"
                  }</option>`;
              })
              .join("")}
                        </select><br><br>
                    </label>
                    <label>
                        Mensaje<br>
                        <textarea id="${field_mensaje}"></textarea><br><br>
                    </label>
                    <label>
                        Estado<br>
                        <input readonly disabled type="text" id="${field_estado}" value="%%">
                        <br>
                        <button id="${btn_leer}">Leido</button>
                        <button id="${btn_desleer}">No leido</button>
                        <br>
                    </label><hr>
                    <button class="btn5" id="${btn_guardar}">Guardar</button>
                    <button class="rojo" id="${btn_borrar}">Borrar</button>
                </fieldset>
                `;
          document.getElementById(btn_leer).onclick = () => {
            document.getElementById(field_estado).value = "leido";
          };
          document.getElementById(btn_desleer).onclick = () => {
            document.getElementById(field_estado).value = "por_leer";
          };
          gun
            .get(TABLE)
            .get("notificaciones")
            .get(mid)
            .once((data, key) => {
              function load_data(data, ENC = "") {
                document.getElementById(nameh1).innerText = key;
                document.getElementById(field_fecha).value = data["Fecha"];
                document.getElementById(field_asunto).value =
                  data["Asunto"] || "";
                document.getElementById(field_mensaje).value =
                  data["Mensaje"] || "";
                document.getElementById(field_origen).value =
                  data["Origen"] || "";
                document.getElementById(field_destino).value =
                  data["Destino"] || "";
                document.getElementById(field_estado).value =
                  data["Estado"] || "";
              }
              if (typeof data == "string") {
                SEA.decrypt(data, SECRET, (data) => {
                  load_data(data, "%E");
                });
              } else {
                load_data(data);
              }
            });
          document.getElementById(btn_guardar).onclick = () => {
            if (document.getElementById(field_origen).value == "") {
              alert("¡Hay que elegir una persona de origen!");
              return;
            }
            if (document.getElementById(field_destino).value == "") {
              alert("¡Hay que elegir una persona de origen!");
              return;
            }
            var data = {
              Fecha: document.getElementById(field_fecha).value,
              Origen: document.getElementById(field_origen).value,
              Destino: document.getElementById(field_destino).value,
              Mensaje: document.getElementById(field_mensaje).value,
              Asunto: document.getElementById(field_asunto).value,
              Estado: document
                .getElementById(field_estado)
                .value.replace("%%", "por_leer"),
            };
            var enc = SEA.encrypt(data, SECRET, (encrypted) => {
              document.getElementById("actionStatus").style.display = "block"
              betterGunPut(
                gun.get(TABLE).get("notificaciones").get(mid),
                encrypted
              );
              toastr.success("Guardado!");
              setTimeout(() => {
                document.getElementById("actionStatus").style.display = "none"
                setUrlHash("notificaciones");
              }, 1500);
            });
          };
          document.getElementById(btn_borrar).onclick = () => {
            if (confirm("¿Quieres borrar esta notificación?") == true) {
              betterGunPut(
                gun.get(TABLE).get("notificaciones").get(mid),
                null
              );
              toastr.error("Borrado!");
              setTimeout(() => {
                setUrlHash("notificaciones");
              }, 1500);
            }
          };
        },
        index: function () {
          const tablebody = safeuuid();
          var btn_new = safeuuid();
          container.innerHTML = `
                <h1>Notificaciones</h1>
                <button id="${btn_new}">Nueva notificación</button>
                <div id="scrolltable"><table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Asunto</th>
                        </tr>
                    </thead>
                    <tbody id="${tablebody}">
                    </tbody>
                </table></div>
                `;
          tableScroll("#scrolltable") // id="scrolltable"
          var tablebody_EL = document.getElementById(tablebody);
          var rows = {};
          function render() {
            function sorter(a, b) {
              if (a.Fecha < b.Fecha) {
                return -1;
              }
              if (a.Fecha > b.Fecha) {
                return 1;
              }
              return 0;
            }
            var tablebody_EL = document.getElementById(tablebody);
            tablebody_EL.innerHTML = "";
            Object.values(rows)
              .sort(sorter)
              .forEach((data) => {
                var new_tr = document.createElement("tr");
                var persona_origen = SC_Personas[data.Origen];
                var persona_destino = SC_Personas[data.Destino];
                new_tr.innerHTML = `
                    <td>${data.Fecha || "????-??-??"}</td>
                    <td class="TextBorder" style="background-color: ${persona_origen.SC_Anilla
                  }; text-align: center"><img src="${persona_origen.Foto ||
                  "static/ico/user_generic.png"
                  }" height="50"><br> ${persona_origen.Nombre || ""}<br> ${persona_origen.Puntos || "?"
                  } punto(s)
                  </td><td class="TextBorder" style="background-color: ${persona_destino.SC_Anilla
                  }; text-align: center"><img src="${persona_destino.Foto ||
                  "static/ico/user_generic.png"
                  }" height="50"><br> ${persona_destino.Nombre || ""}<br> ${persona_destino.Puntos || "?"
                  } punto(s)</td>
                    <td>${data.Asunto || "?"}</td>
                    `;
                new_tr.style.backgroundColor = "#FFCCCB";
                if (data.Estado == "leido") {
                  new_tr.style.backgroundColor = "lightgreen";
                }
                new_tr.onclick = () => {
                  setUrlHash("notificaciones," + data._key);
                };
                tablebody_EL.append(new_tr);
              });
          }
          gun
            .get(TABLE)
            .get("notificaciones")
            .map()
            .on((data, key, _msg, _ev) => {
              EVENTLISTENER = _ev;
              if (data != null) {
                function add_row(data, key) {
                  if (data != null) {
                    data["_key"] = key;
                    rows[key] = data;
                  } else {
                    delete rows[key];
                  }
                  render();
                }
                if (typeof data == "string") {
                  SEA.decrypt(data, SECRET, (data) => {
                    add_row(data, key);
                  });
                } else {
                  add_row(data, key);
                }
              }
            });
          document.getElementById(btn_new).onclick = () => {
            setUrlHash("notificaciones," + safeuuid(""));
          };
        },
      },
    };
    Object.keys(PAGES).forEach((key) => {
      var a = document.createElement("a");
      a.className = "button " + PAGES[key].navcss;
      a.href = "#" + key;
      a.innerText = PAGES[key].Title;
      document.getElementById("appendApps").append(a);
    });
    open_page(location.hash.replace("#", ""));
  </script>
</body>

</html>
